@{
    ViewData["Title"] = "Calendario";
    var encuentros = ViewBag.Encuentros as List<dynamic> ?? new List<dynamic>();
    var tiposOrganizacion = ViewBag.TiposOrganizacion as List<Tipo_Organizacion>;
}

<main class="Calendario-App">
    <section class="Calendario-Panel">
        <header class="Calendario-Header">
            <div class="Calendario-Titulo">
                <h2>Calendario</h2>
                <div class="Calendario-MesActual"></div>
            </div>
            <div class="Calendario-Navegacion">
                <button class="Cal-BtnPrev" type="button" aria-label="Mes anterior">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="Cal-BtnNext" type="button" aria-label="Mes siguiente">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </header>


        <div class="Calendario-Card">
            <div class="Calendario-Semanas">
                <span>LUN</span>
                <span>MAR</span>
                <span>MIÉ</span>
                <span>JUE</span>
                <span>VIE</span>
                <span>SÁB</span>
                <span>DOM</span>
            </div>
            <div class="Calendario-Dias" data-calendario-dias>

            </div>
        </div>


        <div class="Calendario-Acciones">
            <button class="btn-calendario" type="button" data-action="agregar-turno">
                Agregar Turno
            </button>
            <button class="btn-calendario secundario" type="button" data-action="cargar-medicamento">
                Cargar Medicamento
            </button>
        </div>
    </section>

    <!-- Modal/Pestaña para mostrar eventos del día -->
    <div class="Detalle-Evento" data-calendario-detalle hidden>
        <div class="Detalle-Contenido">
            <button class="Detalle-Cerrar" type="button" aria-label="Cerrar">×</button>
            <div class="Detalle-Fecha"></div>
            <div class="Detalle-Titulo">Turno medico</div>
            <div class="Detalle-Info">
                <div class="Detalle-Item">
                    <strong>Dirección:</strong>
                    <span data-detalle-direccion></span>
                </div>
                <div class="Detalle-Item">
                    <strong>Hora:</strong>
                    <span data-detalle-hora></span>
                </div>
                <div class="Detalle-Item">
                    <strong>Descripción:</strong>
                    <span data-detalle-descripcion></span>
                </div>
            </div>
            <div class="Detalle-Acciones">
                <button class="btn-eliminar-evento" type="button" data-action="eliminar-evento">Eliminar Evento</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar encuentro -->
    <div id="modal-agregar-encuentro" class="modal-overlay" hidden>
        <div class="modal-content modal-encuentro">
            <div class="modal-header">
                <h2>Agregar Turno Médico</h2>
                <button class="modal-close" type="button" aria-label="Cerrar" data-action="cerrar-modal-encuentro">×</button>
            </div>
            <div class="modal-body">
                <form id="form-agregar-encuentro">
                    <div class="campo-grupo">
                        <label for="nombre-medico">Nombre Médico *</label>
                        <input type="text" id="nombre-medico" name="nombreMedico" required>
                    </div>
                    <div class="campo-grupo">
                        <label for="apellido-medico">Apellido Médico *</label>
                        <input type="text" id="apellido-medico" name="apellidoMedico" required>
                    </div>
                    <div class="campo-grupo">
                        <label for="fecha-inicio">Fecha Inicio *</label>
                        <input type="datetime-local" id="fecha-inicio" name="fechaInicio" required>
                    </div>
                    <div class="campo-grupo">
                        <label for="fecha-fin">Fecha Fin (opcional)</label>
                        <input type="datetime-local" id="fecha-fin" name="fechaFin">
                    </div>
                    <div class="campo-grupo">
                        <label for="estado-motivo">Estado/Motivo *</label>
                        <input type="text" id="estado-motivo" name="estadoMotivo" required>
                    </div>
                    <div class="campo-grupo">
                        <label for="nombre-organizacion">Nombre Organización *</label>
                        <input type="text" id="nombre-organizacion" name="nombreOrganizacion" required>
                    </div>
                    <div class="campo-grupo">
                        <label for="tipo-organizacion">Tipo Organización *</label>
                        <select id="tipo-organizacion" name="idTipoOrganizacion" required>
                            <option value="">Seleccione un tipo...</option>
                            @if (tiposOrganizacion != null && tiposOrganizacion.Count > 0)
                            {
                                foreach (var tipo in tiposOrganizacion)
                                {
                                    <option value="@tipo.Id">@tipo.TipoOrganizacion</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="campo-grupo">
                        <label for="calle">Calle (opcional, solo si la organización no existe)</label>
                        <input type="text" id="calle" name="calle">
                    </div>
                    <div class="campo-grupo">
                        <label for="altura">Altura (opcional, solo si la organización no existe)</label>
                        <input type="text" id="altura" name="altura">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secundario" data-action="cancelar-modal-encuentro">Cancelar</button>
                <button type="button" class="btn-primario" data-action="guardar-encuentro">Guardar</button>
            </div>
        </div>
    </div>
</main>

<script>
    window.calendarioEventos = @Html.Raw(Json.Serialize(encuentros.Select(e => new {
        id = (int)e.Id,
        fecha = ((DateTime)e.FechaInicio).ToString("yyyy-MM-ddTHH:mm:ss"),
        nombreMedico = (string)(e.NombreMedico ?? ""),
        apellidoMedico = (string)(e.ApellidoMedico ?? ""),
        nombreOrganizacion = (string)(e.NombreOrganizacion ?? ""),
        direccion = (string)(e.Direccion ?? ""),
        descripcion = (string)(e.EstadoMotivo ?? "")
    })));
</script>
