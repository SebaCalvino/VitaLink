@{
    ViewData["Title"] = "Agregar Manualmente - VitaLink";
}

<main class="agregar-main">

    <!-- HEADER -->
    <header class="agregar-header">
        <a href="/Home" class="btn-volver">
            ←
        </a>
        <h1>Agregar Manualmente</h1>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <section class="agregar-card">

        <!-- SELECT TIPO DE DATO -->
        <div class="campo-grupo">
            <select id="tipoDato" class="select-tipo" onchange="cambiarFormulario()">
                <option value="">Tipo de dato</option>
                <option value="vacunacion">Vacunación</option>
                <option value="estudio">Estudio</option>
                <option value="enfermedad">Enfermedad</option>
                <option value="antecedente">Antecedente</option>
            </select>
        </div>

        <!-- Mensaje de éxito/error -->
        <div id="mensajeResultado" class="mensaje-resultado oculto"></div>

        <!-- ================= FORMULARIO VACUNACIÓN ================= -->
        <form id="formVacunacion" class="formulario-manual oculto">

            <div class="campo-grupo">
                <input type="text" name="dosis" placeholder="Dosis (ml)" required>
            </div>

            <div class="campo-grupo">
                <input type="text" name="nombreOrganizacion" placeholder="Nombre de la organización" required>
            </div>

            <div class="campo-grupo">
                <label for="tipo-organizacion-vacuna">Tipo de Organización *</label>
                <select id="tipo-organizacion-vacuna" name="idTipoOrganizacion" required>
                    <option value="">Seleccione un tipo...</option>
                    @{
                        var tiposOrganizacion = ViewBag.TiposOrganizacion as List<Tipo_Organizacion>;
                    }
                    @if (tiposOrganizacion != null && tiposOrganizacion.Count > 0)
                    {
                        foreach (var tipo in tiposOrganizacion)
                        {
                            <option value="@tipo.Id">@tipo.TipoOrganizacion</option>
                        }
                    }
                </select>
            </div>

            <div class="campo-grupo">
                <input type="text" name="nombreVacuna" placeholder="Nombre de la vacuna" required>
            </div>

            <div class="campo-grupo">
                <textarea name="datosInteres" rows="3" placeholder="Datos de interés"></textarea>
            </div>

            <div class="campo-grupo">
                <input type="date" name="fechaAplicacion" required>
            </div>

            <button type="submit" class="btn-agregar-form">
                Agregar
            </button>

        </form>

        <!-- ================= FORMULARIO ESTUDIO ================= -->
        <form id="formEstudio" class="formulario-manual oculto" enctype="multipart/form-data">

            <div class="campo-grupo">
                <input type="text" name="nombreEstudio" placeholder="Nombre del estudio" required>
            </div>

            <div class="campo-grupo">
                <textarea name="observacion" rows="3" placeholder="Resultado / Observación"></textarea>
            </div>

            <div class="campo-grupo">
                <input type="date" name="fecha" required>
            </div>

            <div class="campo-grupo">
                <label class="label-archivo">Adjuntar archivo (opcional)</label>
                <input type="file" name="archivo" id="archivoEstudio" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>

            <button type="submit" class="btn-agregar-form">
                Agregar
            </button>

        </form>

        <!-- ================= FORMULARIO ENFERMEDAD ================= -->
        <form id="formEnfermedad" class="formulario-manual oculto">

            <div class="campo-grupo">
                <input type="text" name="nombreEnfermedad" placeholder="Nombre de la enfermedad" required>
            </div>

            <div class="campo-grupo">
                <textarea name="descripcion" rows="3" placeholder="Descripción"></textarea>
            </div>

            <div class="campo-grupo">
                <input type="date" name="fecha" required>
            </div>

            <button type="submit" class="btn-agregar-form">
                Agregar
            </button>

        </form>

        <!-- ================= FORMULARIO ANTECEDENTE ================= -->
        <form id="formAntecedente" class="formulario-manual oculto">

            <div class="campo-grupo">
                <input type="text" name="antecedente" placeholder="Antecedente médico" required>
            </div>

            <div class="campo-grupo">
                <textarea name="detalle" rows="3" placeholder="Detalle"></textarea>
            </div>

            <div class="campo-grupo">
                <input type="date" name="fecha" required>
            </div>

            <button type="submit" class="btn-agregar-form">
                Agregar
            </button>

        </form>

    </section>

</main>

<script>
// Función para cambiar entre formularios
function cambiarFormulario() {
    const tipo = document.getElementById('tipoDato').value;
    const formularios = document.querySelectorAll('.formulario-manual');
    
    // Ocultar todos los formularios
    formularios.forEach(form => form.classList.add('oculto'));
    
    // Ocultar mensaje
    document.getElementById('mensajeResultado').classList.add('oculto');
    
    // Mostrar el formulario seleccionado
    if (tipo) {
        const formId = 'form' + tipo.charAt(0).toUpperCase() + tipo.slice(1);
        const formSeleccionado = document.getElementById(formId);
        if (formSeleccionado) {
            formSeleccionado.classList.remove('oculto');
        }
    }
}

// Función para mostrar mensaje
function mostrarMensaje(mensaje, esExito) {
    const div = document.getElementById('mensajeResultado');
    div.textContent = mensaje;
    div.className = 'mensaje-resultado ' + (esExito ? 'exito' : 'error');
    div.classList.remove('oculto');
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
        div.classList.add('oculto');
    }, 5000);
}

// Función para limpiar formulario
function limpiarFormulario(form) {
    form.reset();
}

// ==================== SUBMIT VACUNACIÓN ====================
document.getElementById('formVacunacion').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const data = {
        dosis: form.querySelector('[name="dosis"]').value,
        nombreOrganizacion: form.querySelector('[name="nombreOrganizacion"]').value,
        idTipoOrganizacion: parseInt(form.querySelector('[name="idTipoOrganizacion"]').value),
        nombreVacuna: form.querySelector('[name="nombreVacuna"]').value,
        datosInteres: form.querySelector('[name="datosInteres"]').value,
        fechaAplicacion: form.querySelector('[name="fechaAplicacion"]').value
    };

    try {
        const response = await fetch('/Home/InsertarVacunacion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        mostrarMensaje(result.message, result.success);
        
        if (result.success) {
            limpiarFormulario(form);
        }
    } catch (error) {
        mostrarMensaje('Error de conexión', false);
    }
});

// ==================== SUBMIT ESTUDIO ====================
document.getElementById('formEstudio').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const archivoInput = form.querySelector('[name="archivo"]');
    const archivo = archivoInput.files[0];
    
    const data = {
        nombreEstudio: form.querySelector('[name="nombreEstudio"]').value,
        observacion: form.querySelector('[name="observacion"]').value,
        fecha: form.querySelector('[name="fecha"]').value,
        capacidad: archivo ? (archivo.size / 1024).toFixed(2) + ' KB' : null,
        fechaCreacionArchivo: archivo ? new Date().toISOString().split('T')[0] : null,
        nombreArchivo: archivo ? archivo.name : null,
        tipoArchivo: archivo ? archivo.type : null
    };

    try {
        const response = await fetch('/Home/InsertarEstudio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        mostrarMensaje(result.message, result.success);
        
        if (result.success) {
            limpiarFormulario(form);
        }
    } catch (error) {
        mostrarMensaje('Error de conexión', false);
    }
});

// ==================== SUBMIT ENFERMEDAD ====================
document.getElementById('formEnfermedad').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const data = {
        nombreEnfermedad: form.querySelector('[name="nombreEnfermedad"]').value,
        descripcion: form.querySelector('[name="descripcion"]').value,
        fecha: form.querySelector('[name="fecha"]').value
    };

    try {
        const response = await fetch('/Home/InsertarEnfermedad', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        mostrarMensaje(result.message, result.success);
        
        if (result.success) {
            limpiarFormulario(form);
        }
    } catch (error) {
        mostrarMensaje('Error de conexión', false);
    }
});

// ==================== SUBMIT ANTECEDENTE ====================
document.getElementById('formAntecedente').addEventListener('submit', async function(e) {
    e.preventDefault();
    mostrarMensaje('Funcionalidad de antecedentes próximamente disponible', false);
});

</script>

<style>
.mensaje-resultado {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-weight: 500;
    text-align: center;
}

.mensaje-resultado.exito {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.mensaje-resultado.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.mensaje-resultado.oculto {
    display: none;
}
</style>
